name: Check changelog fragments

on: [pull_request]

jobs:
  check-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Verify changelog fragment if required
        run: |
          set -euo pipefail

          echo "Looking for 'changelog-required' label..."

          if echo "${{ toJson(github.event.pull_request.labels.*.name) }}" | grep -q "changelog-required"; then
            echo "Label 'changelog-required' is set. Checking for fragments in docs/release-notes/*.rst..."

            if ! git diff --name-only origin/${{ github.base_ref }}... | grep -q '^docs/release-notes/.*\.rst$'; then
              echo "No changelog fragment found in docs/release-notes/"
              exit 1
            fi

            echo "Changelog fragment found."
          else
            echo "No changelog-required label, skipping this check."
          fi
